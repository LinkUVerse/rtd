name: Generate Rtd CLI Help Snippets

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 8 * * *" # nightly 08:00 UTC

permissions:
  contents: write

concurrency:
  group: rtd-help
  cancel-in-progress: false

jobs:
  build-help:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Determine latest Rtd release tag
        id: release
        run: |
          TAG=$(curl -s https://api.github.com/repos/LinkUVerse/rtd/releases \
            | jq -r 'map(select(.tag_name | startswith("testnet-")))[0].tag_name')
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Restore cached Rtd binary
        id: cache
        uses: actions/cache@v4
        with:
          path: .cache/rtd/${{ steps.release.outputs.tag }}/rtd
          key: rtd-${{ runner.os }}-${{ steps.release.outputs.tag }}

      - name: Download Rtd CLI if cache miss
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          TAG="${{ steps.release.outputs.tag }}"
          mkdir -p ".cache/rtd/${TAG}"
          
          # Try different possible asset names
          ASSETS=(
            "rtd-mainnet-v${TAG#testnet-v}-ubuntu-x86_64.tgz"
            "rtd-testnet-v${TAG#testnet-v}-ubuntu-x86_64.tgz"
            "rtd-${TAG}-ubuntu-x86_64.tgz"
            "rtd-linux-x86_64"
          )
          
          DOWNLOADED=false
          for ASSET in "${ASSETS[@]}"; do
            URL="https://github.com/LinkUVerse/rtd/releases/download/${TAG}/${ASSET}"
            echo "Trying: $URL"
            
            if curl -fsSL -o "/tmp/rtd-download" "$URL" 2>/dev/null; then
              echo "Successfully downloaded: $ASSET"
              
              # Check if it's a tarball
              if [[ "$ASSET" == *.tgz ]]; then
                tar -xzf /tmp/rtd-download -C ".cache/rtd/${TAG}/"
                # Find the rtd binary in extracted files
                find ".cache/rtd/${TAG}/" -name "rtd" -type f -executable -exec mv {} ".cache/rtd/${TAG}/rtd" \;
              else
                mv /tmp/rtd-download ".cache/rtd/${TAG}/rtd"
              fi
              
              chmod +x ".cache/rtd/${TAG}/rtd"
              DOWNLOADED=true
              break
            fi
          done
          
          if [ "$DOWNLOADED" = false ]; then
            echo "Failed to download rtd binary from any known location"
            echo "Available assets for ${TAG}:"
            curl -s "https://api.github.com/repos/LinkUVerse/rtd/releases/tags/${TAG}" | jq -r '.assets[].name'
            exit 1
          fi
          
          # Verify it's actually a binary
          if ! file ".cache/rtd/${TAG}/rtd" | grep -q "executable"; then
            echo "Downloaded file is not an executable:"
            file ".cache/rtd/${TAG}/rtd"
            head -n 5 ".cache/rtd/${TAG}/rtd"
            exit 1
          fi

      - name: Generate MDX snippets (sh fenced)
        run: |
          set -euo pipefail
          TAG="${{ steps.release.outputs.tag }}"
          BIN=".cache/rtd/${TAG}/rtd"
          OUT_DIR="docs/content/snippets/console-output"
          mkdir -p "$OUT_DIR"

          gen() { # gen <filename> <command...>
            local file="$1"; shift
            { echo '```sh'; "$BIN" "$@"; echo '```'; } > "$OUT_DIR/$file"
            echo " - $OUT_DIR/$file"
          }

          echo "Generating help snippets from $BIN"

          gen "rtd-help.mdx" --help
          gen "rtd-client-help.mdx" client --help
          gen "rtd-client-call-help.mdx" client call --help
          gen "rtd-client-ptb-help.mdx" client ptb --help
          gen "rtd-replay-help.mdx" replay --help
          gen "rtd-keytool-sign-help.mdx" keytool sign --help
          gen "rtd-keytool-help.mdx" keytool --help
          gen "rtd-move-help.mdx" move --help
          gen "rtd-move-build-help.mdx" move build --help
          gen "rtd-validator-help.mdx" validator --help
          gen "rtd-validator-report-validator-help.mdx" validator report-validator --help

      - name: Diff guard
        id: diff
        run: |
          if git diff --quiet docs/content/snippets/console-output/; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes detected."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected."
          fi

      - name: Commit & push changes
        if: steps.diff.outputs.changed == 'true'
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add docs/content/snippets/console-output/*.mdx
          git commit -m "chore(ci): update Rtd CLI help snippets (${{ steps.release.outputs.tag }})"
          git push
